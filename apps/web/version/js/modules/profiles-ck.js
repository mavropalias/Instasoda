// =========================================================================
// MyProfileView - the profile page of the person using the app
// =========================================================================
var MyProfileView=Backbone.View.extend({events:{"click #saveProfileButton":"save","click #editProfileButton":"toggleProfileOptions","click #cancelProfileButton":"toggleProfileOptions","click .photoMakeDefault":"photoMakeDefault","click .photoDelete":"photoDelete"},initialize:function(e){console.log("  ~ initializing MyProfileView");_.bindAll(this);this.myPhotosView=new MyPhotosView({model:this.model});this.likesListView=new LikesListView({model:this.model})},render:function(e){console.log("  ~ rendering MyProfileView");var t=this,n=this.model.get("l");this.model.set("likeCount",n.length);var r=$("#tplMyProfile").html();this.$el.html(Mustache.to_html(r,this.model.toJSON()));this.myPhotosView.setElement(this.$("#userPhotosList")).render();this.likesListView.setElement(this.$("#allLikes")).render();setTimeout(function(){t.onView()},0)},onView:function(){var e=this,t=0;console.log("- creating upload widget");var n=new qq.FileUploader({element:document.getElementById("uploadWidget"),action:sApi+"user/"+user.get("_id")+"/photo",allowedExtensions:["jpg","jpeg","png","gif"],debug:!1,sizeLimit:3e6,maxConnections:3,onSubmit:function(e,n){t++},onProgress:function(e,t,n,r){$(".qq-upload-drop-area").addClass("working")},onComplete:function(n,r,i){t--;if(i.success===!0){var s=Math.floor(Math.random()*10001)+Math.floor(Math.random()*10001),o=e.model.get("p");o.push({id:s,f:i.file,p:1,d:0});e.model.set({p:o});console.log("- inserting new photo to the model");e.myPhotosView.trigger("newPhoto",{p:{id:s,f:i.file,p:1,d:0}})}else console.log("- error uploading photo "+r+" ("+i.error+")");if(t===0){$(".qq-upload-drop-area").removeClass("working");e.save()}}});this.$("#userPhotos").on("focusin",function(){e.$(".fancybox-thumb").fancybox({prevEffect:"elastic",nextEffect:"elastic",padding:0,helpers:{title:{type:"outside"},overlay:{opacity:.85,css:{"background-color":"#000"}},thumbs:{width:50,height:50}}})})},save:function(){console.log("- saving user");_this=this;$("#saveProfileButton").addClass("transparent");$("#working").removeClass("transparent");this.model.save({u:this.$("input[name=username]").val(),a:this.$("#aboutMe").html(),m:this.$("input[name=interestedInMen]:checked").length>0?1:0,w:this.$("input[name=interestedInWomen]:checked").length>0?1:0,ff:this.$("input[name=findFriends]:checked").length>0?1:0,fd:this.$("input[name=findDates]:checked").length>0?1:0},{error:function(e,t){alert("User save failed!");$("#saveProfileButton").removeClass("transparent");$("#working").addClass("transparent")},success:function(e,t){console.log("- got an API response");if(typeof e.attributes._id!="undefined"&&typeof t.error=="undefined"){console.log("- API call was successful");_this.toggleProfileOptions();store.set("user",_this.model);$("#saveProfileButton").removeClass("transparent");$("#working").addClass("transparent")}else{console.log("- API call failed: "+t.error);alert("User save failed: "+t.error);$("#saveProfileButton").removeClass("transparent");$("#working").addClass("transparent")}}})},photoMakeDefault:function(e){console.log("- changing default photo");var t=this;e.preventDefault();e.stopPropagation();var n=parseInt($(e.currentTarget).parent().find("> img").attr("id")),r=$(e.currentTarget).parent().parent().find("img").attr("src"),i=this.model.get("p");console.log(r);for(var s=0;s<i.length;s++)if(i[s].id===n){i[s].d=1;console.log("- new default photo: "+n)}else i[s].d=0;$("#profile-pictures #"+n+" .picture-is-default").html("saving...");this.model.save({p:i},{error:function(e,t){$("#profile-pictures #"+n+" .picture-is-default").html("make default");alert("Error: could not change photo status")},success:function(e,i){store.set("user",t.model);$("#profile-pictures .photoMakeDefault").removeClass("hidden");$("#profile-pictures .photoIsDefault").addClass("hidden");$("#profile-pictures .photo").removeClass("picture-is-default");$("#profile-pictures #"+n).addClass("picture-is-default");$("#profile-pictures #"+n+" .photoMakeDefault").addClass("hidden");$("#profile-pictures #"+n+" .photoIsDefault").removeClass("hidden");$("#profile-pictures #"+n+" .photoMakeDefault").html("make default");t.$("#basicInfo .defaultPhoto img").attr("src",r)}})},photoDelete:function(e){var t=this;console.log("- deleting photo");e.preventDefault();e.stopPropagation();var n=parseInt($(e.currentTarget).parent().parent().attr("id")),r=!1;this.model.get("p").forEach(function(e,t){if(e.id===n&&e.d===1){console.log(" - warning: deleting the default photo!");r=!0}});$.ajax({url:sApi+"user/"+user.get("_id")+"/photo/"+n,type:"DELETE",data:{fTkn:user.get("fTkn")},success:function(e,i,s){if(i==="success"){console.log("- photo deleted from S3");var o=t.model.get("p");for(var u=0;u<o.length;u++)o[u].id===n&&o.splice(u,1);t.model.set({p:o});t.save();t.myPhotosView.trigger("deletePhoto",n);console.log(" - replacing default photo with a generic one");r&&t.$("#basicInfo .photo img").attr("src","http://img.instasoda.com/i/noPhoto.png")}else alert("Error deleting photo")}})},toggleProfileOptions:function(e){var t=$(".flipContainer");if(t.hasClass("rotateY")){t.removeClass("rotateY");$("#aboutMe").hide();$(".aboutText").fadeIn()}else{t.addClass("rotateY");$("#aboutMe").fadeIn();$(".aboutText").hide()}}}),UsersFullView=Backbone.View.extend({events:{"click #sendMessage":"sendMessage","click #handleFavourite":"handleFavourite"},initialize:function(){console.log("  ~ initializing UsersFullView");_.bindAll(this);this.myPhotosView=new MyPhotosView({model:this.model});this.likesListView=new LikesListView({model:this.model});this.commonLikesListView=new LikesListView({model:this.model})},render:function(){console.log("  ~ rendering UsersFullView for: "+this.model.get("_id"));var e=this;this.model.set("likeCount",this.model.get("l").length);this.model.set({isFaved:!1});_.indexOf(user.get("favs"),this.model.get("_id"))!=-1&&this.model.set({isFaved:!0});var t=IS.getCommonLikes(this.model.get("l"));this.model.set("commonLikesCount",t.length);this.model.set("commonLikes",t);var n=$("#tplUsersProfile").html();this.$el.html(Mustache.to_html(n,this.model.toJSON()));this.myPhotosView.setElement(this.$("#userPhotosList")).render();this.likesListView.setElement(this.$("#facebookLikes")).render();this.commonLikesListView.setElement(this.$("#commonLikes")).render(null,null,!0);setTimeout(function(){e.onView()},0)},onView:function(){var e=this.model.get("l").length,t=this.model.get("commonLikesCount"),n=this.model.get("p").length;this.$(".fancybox-thumb").fancybox({prevEffect:"elastic",nextEffect:"elastic",padding:0,helpers:{title:{type:"outside"},overlay:{opacity:.85,css:{"background-color":"#000"}},thumbs:{width:50,height:50}}})},sendMessage:function(){metabarView.chatSessionTabs.initiateSessionWith(this.model.get("_id"),this.model.get("u"),this.model.get("ag"),this.model.get("p"))},handleFavourite:function(){if(_.indexOf(user.get("favs"),this.model.get("_id"))===-1)var e="add";else var e="remove";IS.handleFavourite(this.model.get("_id"),this.model.get("u"),e)}}),MyPhotosView=Backbone.View.extend({initialize:function(){console.log("  ~ initializing MyPhotosView");_.bindAll(this);this.bind("newPhoto",this.renderNewPhoto);this.bind("deletePhoto",this.deletePhoto)},render:function(){console.log("  ~ rendering MyPhotosView");var e=$("#tplMyPhotos").html();this.$el.html(Mustache.to_html(e,this.model.toJSON()));this.$(".photo img").load(function(){$(this).parent().removeClass("transparent")})},renderNewPhoto:function(e){console.log("  ~ rendering new photo ");var t=$("#tplMyPhotos").html();this.$el.append(Mustache.to_html(t,e));this.$(".photo img").load(function(){$(this).parent().removeClass("transparent")})},deletePhoto:function(e){console.log("  ~ deleting photo ");var t=this;this.$("#"+e).addClass("transparent");setTimeout(function(){t.$("#"+e).detach()},400)}});