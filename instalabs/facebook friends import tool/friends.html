<!DOCTYPE html>
<html lang="en">
<head>

  <!-- TITLE -->
  <title>Instasoda - fizzy not fussy!</title>

  <!-- Scripts for the less fortunate browsers -->
  <!--[if lt IE 9]>
    <script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js" type="text/javascript"></script>
    <script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/ie7-squish.js" type="text/javascript"></script>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- OPEN GRAPH -->
  <meta property="og:title" content="Instasoda" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="http://instasoda.com" />
  <meta property="og:image" content="" />
  <meta property="og:site_name" content="Instasoda" />
  <meta property="fb:admins" content="659710874" />

  <!-- MISC TAGS -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- SCRIPTS START -->
  <script type="text/javascript">

  function facebookAuth() {
    var self = this;
    console.log('> Doing Facebook auth');
    
    FB.getLoginStatus(function(res) {
      var button = document.getElementById('fb-auth');
      if (!res.authResponse) {
        //user is not connected to the app or logged out
        //button.innerHTML = 'Login with Facebook';
        
          FB.login(function(response) { 
            // FB.Event.subscribe('auth.statusChange') will take care of the rest
            self.facebookAuth();
          },
          {
            scope:'friends_relationships,friends_location,friends_hometown,friends_birthday,'
            + 'friends_activities,friends_education_history,friends_interests,'
            + 'friends_likes,friends_photos'
          });    
        
      } else {
        if (res.status === 'connected') {
          console.log('> User is logged into Facebook and has authenticated the application');            
          
          // get facebook token data
          var fbToken = res.authResponse.accessToken;
          var fbTokenExpires = res.authResponse.expiresIn;
                      
          // Check if token is still valid
          if(fbTokenExpires > 0) {
            console.log('> Facebook token expires in ' + (fbTokenExpires / 60) + ' minutes');
            console.log('>   -> ' + fbToken);
            // get third_party_id from Facebook and login the user
            FB.api(
              {
                method: 'fql.query',
                query: 'SELECT third_party_id FROM user WHERE uid=me()'
              },
              function(res) {
                console.log('> Attempting to login the user');
                IS.login(fbToken, res[0].third_party_id, function(err) {
                  if(!err) {
                    console.log('> SUCCESS! User is logged in');
                  } else {
                    console.log('> FAIL: Need to create new account');
                  }
                });
              }
            );
          } else {
            console.log('- Facebook token has expired');
            FB.logout();
          }
        } else if (res.status === 'not_authorized') {
          console.log('> User is logged into Facebook but has not authenticated the application');
          //IS.navigateTo('');
        } else {
          console.log('> User is not logged into Facebook at this time');
          //IS.navigateTo('');
        }
      }
    });  
  }

  </script>
  <!-- SCRIPTS END -->


  <!-- OPEN GRAPH -->
  <meta property="og:title" content="Instasoda" />
  <meta property="og:type" content="blog" />
  <meta property="og:url" content="http://instasoda.com" />
  <meta property="og:image" content="" />
  <meta property="og:site_name" content="Instasoda" />
  <meta property="fb:admins" content="659710874" />

</head>
<body>

  <!-------------------------------------------------------------------------->
  <!-- FACEBOOK SDK -->
  <!-------------------------------------------------------------------------->

    <div id="fb-root"></div>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '372501186096211', // ##appId##
          channelUrl : 'http://localhost:8081/is/channel.html', // ##channel##
          status     : true,
          cookie     : true,
          oauth      : true,
        });

        // ask for user permissions
        facebookAuth();
      };
      (function(d){
        var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement('script'); js.id = id; js.async = true;
        js.src = "//connect.facebook.net/en_US/all.js";
        ref.parentNode.insertBefore(js, ref);
       }(document));
    </script>


  <!-------------------------------------------------------------------------->
  <!-- CONTENT -->
  <!-------------------------------------------------------------------------->

    <button id="fb-auth">Connect with Facebook</button>

 
</body>
</html>
